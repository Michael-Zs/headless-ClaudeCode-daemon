#!/bin/bash

# Claude PTY Hook 脚本
# 用法: claude-pty-hook set-status
# 从环境变量 CLAUDE_PTY_SESSION_ID 获取 session_id

SOCKET_PATH="${CLAUDE_PTY_SOCKET:-/run/user/1000/claude-pty.sock}"

ACTION="$1"

# 优先从环境变量获取 session_id
SESSION_ID="${CLAUDE_PTY_SESSION_ID}"

# 如果环境变量没有，尝试从文件读取
if [ -z "$SESSION_ID" ] && [ -f "$HOME/.claude-pty-session" ]; then
    SESSION_ID=$(cat "$HOME/.claude-pty-session")
fi

if [ -z "$SESSION_ID" ]; then
    echo "Error: session_id not provided" >> /tmp/claude-pty-hook-test.log
    exit 1
fi

case "$ACTION" in
    set-status)
        # 设置等待状态为 true
        curl -s -X POST \
            -d "{\"action\":\"set_status\",\"session_id\":\"$SESSION_ID\",\"waiting\":true}" \
            --unix-socket "$SOCKET_PATH" \
            http://localhost/ >> /tmp/claude-pty-hook-test.log 2>&1
        echo "set-status: $SESSION_ID" >> /tmp/claude-pty-hook-test.log
        ;;
    unset-status)
        # 设置等待状态为 false
        curl -s -X POST \
            -d "{\"action\":\"set_status\",\"session_id\":\"$SESSION_ID\",\"waiting\":false}" \
            --unix-socket "$SOCKET_PATH" \
            http://localhost/ >> /tmp/claude-pty-hook-test.log 2>&1
        ;;
    *)
        echo "Unknown action: $ACTION" >> /tmp/claude-pty-hook-test.log
        exit 1
        ;;
esac
