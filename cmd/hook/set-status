#!/bin/bash

# Claude PTY Hook 脚本
# 用法: claude-pty-hook <running|stop|need_permission>
# 从环境变量 CLAUDE_PTY_SESSION_ID 获取 session_id

SOCKET_PATH="${CLAUDE_PTY_SOCKET:-/tmp/claude-pty.sock}"

ACTION="$1"

# 优先从环境变量获取 session_id
SESSION_ID="${CLAUDE_PTY_SESSION_ID}"

# 如果环境变量没有，尝试从文件读取
if [ -z "$SESSION_ID" ] && [ -f "$HOME/.claude-pty-session" ]; then
  SESSION_ID=$(cat "$HOME/.claude-pty-session")
fi

if [ -z "$SESSION_ID" ]; then
  echo "Error: session_id not provided" >>/tmp/claude-pty-hook-test.log
  exit 1
fi

case "$ACTION" in
running)
  # Claude 正在运行
  curl -s -X POST \
    -d "{\"action\":\"set_status\",\"session_id\":\"$SESSION_ID\",\"status\":\"running\"}" \
    --unix-socket "$SOCKET_PATH" \
    http://localhost/ >>/tmp/claude-pty-hook-test.log 2>&1
  echo "running: $SESSION_ID: $SOCKET_PATH" >>/tmp/claude-pty-hook-test.log
  ;;
stop)
  # Claude 已停止
  curl -s -X POST \
    -d "{\"action\":\"set_status\",\"session_id\":\"$SESSION_ID\",\"status\":\"stopped\"}" \
    --unix-socket "$SOCKET_PATH" \
    http://localhost/ >>/tmp/claude-pty-hook-test.log 2>&1
  echo "stopped: $SESSION_ID" >>/tmp/claude-pty-hook-test.log
  ;;
need_permission)
  # 需要用户授权
  curl -s -X POST \
    -d "{\"action\":\"set_status\",\"session_id\":\"$SESSION_ID\",\"status\":\"need_permission\"}" \
    --unix-socket "$SOCKET_PATH" \
    http://localhost/ >>/tmp/claude-pty-hook-test.log 2>&1
  echo "need_permission: $SESSION_ID" >>/tmp/claude-pty-hook-test.log
  ;;
*)
  echo "Unknown action: $ACTION" >>/tmp/claude-pty-hook-test.log
  exit 1
  ;;
esac
